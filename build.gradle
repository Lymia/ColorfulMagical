plugins {
	id "architectury-plugin" version "3.4.151" apply false
	id 'dev.architectury.loom' version '1.4.380' apply false
	id 'org.ajoberstar.grgit' version '5.0.0'
	id 'com.github.johnrengelman.shadow' version "8.1.1"
}

allprojects {
	apply plugin: "java"
	apply plugin: 'application'
	apply plugin: 'com.github.johnrengelman.shadow'

	sourceCompatibility = JavaVersion.VERSION_1_8
	targetCompatibility = JavaVersion.VERSION_1_8

	version = "${project.mod_version}${getVersionMetadata()}+mc${project.minecraft_version}"
	group = project.maven_group

	repositories {
		maven {
			url "https://maven.architectury.dev/"
		}
	}

	tasks.withType(JavaCompile).configureEach {
		it.options.encoding = "UTF-8"
	}

	java {
		withSourcesJar()
	}
}

def getVersionMetadata() {
	// CI builds only
	if (grgit != null) {
		def head = grgit.head()

		if (grgit.tag.list().findAll { it.commit == head}.isEmpty()) {
			def id = head.abbreviatedId
			if (!grgit.status().clean) {
				id += ".dirty"
			}
			return "-r${id}"
		} else {
			return ""
		}
	}

	// No tracking information could be found about the build
	return "-unknown"
}